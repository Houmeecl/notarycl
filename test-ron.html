<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuSignPro RON - Pruebas de Notarizaci√≥n Remota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
        .camera-preview { 
            background: #f3f4f6; 
            border: 2px dashed #d1d5db; 
            border-radius: 8px;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .document-upload {
            border: 2px dashed #3b82f6;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .document-upload:hover {
            border-color: #1d4ed8;
            background-color: #eff6ff;
        }
        .signature-pad { 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            background: white;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-blue-600">üé• DocuSignPro RON</h1>
                        <p class="text-sm text-gray-600">Remote Online Notarization & Identity Verification</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="connection-status" class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full" id="status-dot"></div>
                            <span class="text-sm text-gray-600" id="status-text">Conectando...</span>
                        </div>
                        <div id="user-info" class="text-sm text-gray-600">No autenticado</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Autenticaci√≥n r√°pida -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">üîê Autenticaci√≥n</h2>
                <div class="flex space-x-4 items-end">
                    <div class="flex-1">
                        <input type="text" id="username" placeholder="Usuario (admin)" value="admin" class="w-full p-2 border rounded">
                    </div>
                    <div class="flex-1">
                        <input type="password" id="password" placeholder="Contrase√±a" class="w-full p-2 border rounded">
                    </div>
                    <button onclick="quickLogin()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                        Login
                    </button>
                </div>
                <div id="auth-result" class="mt-4"></div>
            </div>

            <!-- Navegaci√≥n por pesta√±as -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                        <button onclick="showTab('identity')" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600" data-tab="identity">
                            üÜî Verificaci√≥n de Identidad
                        </button>
                        <button onclick="showTab('ron')" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="ron">
                            üé• Sesiones RON
                        </button>
                        <button onclick="showTab('biometric')" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="biometric">
                            üëÅÔ∏è Verificaci√≥n Biom√©trica
                        </button>
                        <button onclick="showTab('compliance')" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" data-tab="compliance">
                            üìã Cumplimiento Legal
                        </button>
                    </nav>
                </div>

                <!-- Panel de Verificaci√≥n de Identidad -->
                <div id="identity-panel" class="tab-panel p-6">
                    <h3 class="text-xl font-semibold mb-6">üÜî Sistema de Verificaci√≥n de Identidad</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Iniciar Verificaci√≥n -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="font-semibold mb-4">Iniciar Nueva Verificaci√≥n</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Prop√≥sito</label>
                                    <select id="verification-purpose" class="w-full p-2 border rounded">
                                        <option value="document_signing">Firma de Documentos</option>
                                        <option value="account_verification">Verificaci√≥n de Cuenta</option>
                                        <option value="ron_session">Sesi√≥n RON</option>
                                        <option value="payment_verification">Verificaci√≥n de Pago</option>
                                    </select>
                                </div>
                                <button onclick="startIdentityVerification()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                    Iniciar Verificaci√≥n
                                </button>
                            </div>
                            <div id="verification-result" class="mt-4"></div>
                        </div>

                        <!-- Estado de Verificaciones -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="font-semibold mb-4">Mis Verificaciones</h4>
                            <button onclick="loadMyVerifications()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 mb-4">
                                Cargar Verificaciones
                            </button>
                            <div id="my-verifications" class="space-y-3 max-h-60 overflow-y-auto">
                                <!-- Verificaciones aparecen aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <!-- An√°lisis de Documentos -->
                    <div class="mt-8 bg-white border rounded-lg p-6">
                        <h4 class="font-semibold mb-4">üìÑ An√°lisis de Documentos de Identidad</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                <select id="doc-type" class="w-full p-2 border rounded mb-4">
                                    <option value="national_id">C√©dula de Identidad</option>
                                    <option value="passport">Pasaporte</option>
                                    <option value="drivers_license">Licencia de Conducir</option>
                                    <option value="utility_bill">Cuenta de Servicios</option>
                                </select>
                                
                                <div class="document-upload p-6 text-center cursor-pointer" onclick="document.getElementById('front-image').click()">
                                    <i class="fas fa-camera text-3xl text-blue-500 mb-2"></i>
                                    <p class="text-sm text-gray-600">Subir imagen frontal del documento</p>
                                    <input type="file" id="front-image" accept="image/*" class="hidden" onchange="previewImage(this, 'front-preview')">
                                </div>
                                <div id="front-preview" class="mt-2"></div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Imagen Posterior (opcional)</label>
                                <div class="document-upload p-6 text-center cursor-pointer mt-6" onclick="document.getElementById('back-image').click()">
                                    <i class="fas fa-camera text-3xl text-blue-500 mb-2"></i>
                                    <p class="text-sm text-gray-600">Subir imagen posterior del documento</p>
                                    <input type="file" id="back-image" accept="image/*" class="hidden" onchange="previewImage(this, 'back-preview')">
                                </div>
                                <div id="back-preview" class="mt-2"></div>
                                
                                <button onclick="analyzeDocument()" class="w-full mt-4 bg-purple-500 text-white py-2 rounded hover:bg-purple-600">
                                    <i class="fas fa-search mr-2"></i>
                                    Analizar Documento
                                </button>
                            </div>
                        </div>
                        <div id="document-analysis-result" class="mt-6"></div>
                    </div>
                </div>

                <!-- Panel de Sesiones RON -->
                <div id="ron-panel" class="tab-panel p-6 hidden">
                    <h3 class="text-xl font-semibold mb-6">üé• Remote Online Notarization</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Programar Sesi√≥n RON -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="font-semibold mb-4">Programar Nueva Sesi√≥n RON</h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ID del Documento</label>
                                    <input type="text" id="ron-document-id" placeholder="doc_xxxxx" class="w-full p-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ID del Notario</label>
                                    <select id="ron-notary-id" class="w-full p-2 border rounded">
                                        <option value="1">Notario Principal (ID: 1)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Fecha y Hora</label>
                                    <input type="datetime-local" id="ron-scheduled-at" class="w-full p-2 border rounded">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Participantes</label>
                                    <textarea id="ron-participants" placeholder='[{"name":"Cliente","email":"cliente@email.com","role":"client","ipAddress":"127.0.0.1","deviceInfo":"Chrome"}]' class="w-full p-2 border rounded h-20"></textarea>
                                </div>
                                <button onclick="scheduleRONSession()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                    <i class="fas fa-calendar-plus mr-2"></i>
                                    Programar Sesi√≥n RON
                                </button>
                            </div>
                            <div id="ron-schedule-result" class="mt-4"></div>
                        </div>

                        <!-- Mis Sesiones RON -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h4 class="font-semibold mb-4">Mis Sesiones RON</h4>
                            <button onclick="loadRONSessions()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 mb-4">
                                Cargar Sesiones
                            </button>
                            <div id="ron-sessions-list" class="space-y-3 max-h-60 overflow-y-auto">
                                <!-- Sesiones aparecen aqu√≠ -->
                            </div>
                        </div>
                    </div>

                    <!-- Simulador de Sesi√≥n RON -->
                    <div class="mt-8 bg-white border rounded-lg p-6">
                        <h4 class="font-semibold mb-4">üé¨ Simulador de Sesi√≥n RON</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center">
                                <div class="camera-preview mb-4">
                                    <div class="text-center">
                                        <i class="fas fa-video text-4xl text-gray-400 mb-2"></i>
                                        <p class="text-sm text-gray-500">C√°mara del Cliente</p>
                                        <button onclick="simulateVideoFeed('client')" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-xs">
                                            Simular Video
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm font-medium">Cliente</p>
                            </div>
                            
                            <div class="text-center">
                                <div class="camera-preview mb-4">
                                    <div class="text-center">
                                        <i class="fas fa-balance-scale text-4xl text-gray-400 mb-2"></i>
                                        <p class="text-sm text-gray-500">Notario</p>
                                        <button onclick="simulateVideoFeed('notary')" class="mt-2 bg-green-500 text-white px-3 py-1 rounded text-xs">
                                            Simular Video
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm font-medium">Notario</p>
                            </div>
                            
                            <div class="text-center">
                                <div class="camera-preview mb-4">
                                    <div class="text-center">
                                        <i class="fas fa-eye text-4xl text-gray-400 mb-2"></i>
                                        <p class="text-sm text-gray-500">Testigo</p>
                                        <button onclick="simulateVideoFeed('witness')" class="mt-2 bg-orange-500 text-white px-3 py-1 rounded text-xs">
                                            Simular Video
                                        </button>
                                    </div>
                                </div>
                                <p class="text-sm font-medium">Testigo</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-center space-x-4">
                            <button onclick="simulateRONStep('identity_verification')" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                                1. Verificar Identidad
                            </button>
                            <button onclick="simulateRONStep('document_review')" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                2. Revisar Documento
                            </button>
                            <button onclick="simulateRONStep('signing')" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                                3. Firmar
                            </button>
                            <button onclick="simulateRONStep('completed')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                4. Completar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Panel de Verificaci√≥n Biom√©trica -->
                <div id="biometric-panel" class="tab-panel p-6 hidden">
                    <h3 class="text-xl font-semibold mb-6">üëÅÔ∏è Verificaci√≥n Biom√©trica y Detecci√≥n de Vida</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Detecci√≥n de Vida -->
                        <div class="bg-white border rounded-lg p-6">
                            <h4 class="font-semibold mb-4">Detecci√≥n de Vida (Liveness)</h4>
                            
                            <div class="camera-preview mb-4" id="liveness-camera">
                                <div class="text-center">
                                    <i class="fas fa-camera text-4xl text-blue-500 mb-2"></i>
                                    <p class="text-sm text-gray-600">C√°mara para detecci√≥n de vida</p>
                                    <button onclick="startLivenessCheck()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">
                                        Iniciar Detecci√≥n
                                    </button>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <button onclick="performLivenessCheck('blink_detection')" class="w-full bg-yellow-500 text-white py-2 rounded hover:bg-yellow-600">
                                    <i class="fas fa-eye mr-2"></i>
                                    Detecci√≥n de Parpadeo
                                </button>
                                <button onclick="performLivenessCheck('head_movement')" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600">
                                    <i class="fas fa-arrows-alt mr-2"></i>
                                    Movimiento de Cabeza
                                </button>
                                <button onclick="performLivenessCheck('smile_detection')" class="w-full bg-pink-500 text-white py-2 rounded hover:bg-pink-600">
                                    <i class="fas fa-smile mr-2"></i>
                                    Detecci√≥n de Sonrisa
                                </button>
                                <button onclick="performLivenessCheck('voice_challenge')" class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600">
                                    <i class="fas fa-microphone mr-2"></i>
                                    Desaf√≠o de Voz
                                </button>
                            </div>
                            
                            <div id="liveness-result" class="mt-4"></div>
                        </div>

                        <!-- Verificaci√≥n Biom√©trica -->
                        <div class="bg-white border rounded-lg p-6">
                            <h4 class="font-semibold mb-4">Verificaci√≥n Biom√©trica</h4>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Biometr√≠a</label>
                                    <select id="biometric-type" class="w-full p-2 border rounded">
                                        <option value="facial">Reconocimiento Facial</option>
                                        <option value="fingerprint">Huella Dactilar</option>
                                        <option value="voice">Reconocimiento de Voz</option>
                                        <option value="iris">Reconocimiento de Iris</option>
                                    </select>
                                </div>
                                
                                <div class="camera-preview" id="biometric-capture">
                                    <div class="text-center">
                                        <i class="fas fa-fingerprint text-4xl text-green-500 mb-2"></i>
                                        <p class="text-sm text-gray-600">Captura biom√©trica</p>
                                        <button onclick="captureBiometric()" class="mt-2 bg-green-500 text-white px-4 py-2 rounded">
                                            Capturar
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="text-center">
                                    <button onclick="performBiometricVerification()" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
                                        <i class="fas fa-check mr-2"></i>
                                        Verificar Biometr√≠a
                                    </button>
                                </div>
                            </div>
                            
                            <div id="biometric-result" class="mt-4"></div>
                        </div>
                    </div>

                    <!-- Autenticaci√≥n Basada en Conocimiento (KBA) -->
                    <div class="mt-8 bg-white border rounded-lg p-6">
                        <h4 class="font-semibold mb-4">üß† Autenticaci√≥n Basada en Conocimiento (KBA)</h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <button onclick="generateKBAQuestions()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 mb-4">
                                    Generar Preguntas KBA
                                </button>
                                <div id="kba-questions" class="space-y-4">
                                    <!-- Preguntas aparecen aqu√≠ -->
                                </div>
                            </div>
                            <div>
                                <div id="kba-instructions" class="bg-blue-50 p-4 rounded mb-4">
                                    <h5 class="font-medium text-blue-800 mb-2">Instrucciones KBA</h5>
                                    <p class="text-sm text-blue-700">
                                        Responda las preguntas basadas en su informaci√≥n personal y historial.
                                        Se requiere al menos 70% de respuestas correctas para aprobar.
                                    </p>
                                </div>
                                <div id="kba-result" class="mt-4"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel de Cumplimiento -->
                <div id="compliance-panel" class="tab-panel p-6 hidden">
                    <h3 class="text-xl font-semibold mb-6">üìã Cumplimiento Legal y Auditor√≠a</h3>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white border rounded-lg p-6">
                            <h4 class="font-semibold mb-4">Estad√≠sticas de Cumplimiento</h4>
                            <button onclick="loadComplianceStats()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 mb-4">
                                Cargar Estad√≠sticas
                            </button>
                            <div id="compliance-stats" class="space-y-3">
                                <!-- Estad√≠sticas aparecen aqu√≠ -->
                            </div>
                        </div>
                        
                        <div class="bg-white border rounded-lg p-6">
                            <h4 class="font-semibold mb-4">Eventos de Seguridad</h4>
                            <button onclick="loadSecurityEvents()" class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600 mb-4">
                                Cargar Eventos
                            </button>
                            <div id="security-events" class="space-y-3 max-h-60 overflow-y-auto">
                                <!-- Eventos aparecen aqu√≠ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log de Actividad -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">üìã Log de Actividad RON</h2>
                    <button onclick="clearLog()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        Limpiar
                    </button>
                </div>
                <div id="activity-log" class="bg-gray-50 p-4 rounded text-sm font-mono h-40 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let currentVerificationSession = null;

        // Funciones de utilidad
        function log(message) {
            const logDiv = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('activity-log').innerHTML = '';
        }

        function showTab(tabName) {
            // Ocultar todos los paneles
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // Mostrar panel seleccionado
            document.getElementById(`${tabName}-panel`).classList.remove('hidden');
            
            // Actualizar botones de pesta√±as
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-blue-500', 'text-blue-600');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
        }

        async function apiCall(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                }
            };

            try {
                const response = await fetch(endpoint, { ...defaultOptions, ...options });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP ${response.status}`);
                }
                
                return response.json();
            } catch (error) {
                console.error(`API Error: ${endpoint}`, error);
                throw error;
            }
        }

        // Funciones de autenticaci√≥n
        async function quickLogin() {
            try {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (!username || !password) {
                    throw new Error('Usuario y contrase√±a requeridos');
                }

                log(`üîê Intentando login: ${username}`);
                
                const result = await apiCall('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });

                authToken = result.token;
                localStorage.setItem('authToken', authToken);
                currentUser = result.user;

                document.getElementById('user-info').innerHTML = `üë§ ${result.user.fullName} (${result.user.role})`;
                document.getElementById('status-dot').className = 'w-3 h-3 bg-green-500 rounded-full';
                document.getElementById('status-text').textContent = 'Conectado';

                document.getElementById('auth-result').innerHTML = `
                    <div class="p-3 bg-green-100 border border-green-400 rounded">
                        <strong>‚úÖ ${result.message}</strong>
                    </div>
                `;

                log(`‚úÖ Login exitoso para ${username}`);
            } catch (error) {
                document.getElementById('auth-result').innerHTML = `
                    <div class="p-3 bg-red-100 border border-red-400 rounded">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
                log(`‚ùå Error en login: ${error.message}`);
            }
        }

        // Funciones de verificaci√≥n de identidad
        async function startIdentityVerification() {
            try {
                if (!authToken) {
                    throw new Error('Debes estar autenticado');
                }
                
                const purpose = document.getElementById('verification-purpose').value;
                
                log(`üÜî Iniciando verificaci√≥n de identidad: ${purpose}`);
                
                const result = await apiCall('/api/identity/verify', {
                    method: 'POST',
                    body: JSON.stringify({ purpose })
                });

                currentVerificationSession = result.sessionId;

                document.getElementById('verification-result').innerHTML = `
                    <div class="p-4 bg-green-100 border border-green-400 rounded">
                        <strong>‚úÖ ${result.message}</strong><br>
                        <div class="text-sm mt-2">
                            <strong>ID de Sesi√≥n:</strong> ${result.sessionId}<br>
                            <strong>M√©todos Requeridos:</strong> ${result.requiredMethods.join(', ')}<br>
                            <strong>Score Requerido:</strong> ${result.session.requiredScore}%
                        </div>
                    </div>
                `;

                log(`‚úÖ Sesi√≥n de verificaci√≥n creada: ${result.sessionId}`);
            } catch (error) {
                document.getElementById('verification-result').innerHTML = `
                    <div class="p-3 bg-red-100 border border-red-400 rounded">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
                log(`‚ùå Error iniciando verificaci√≥n: ${error.message}`);
            }
        }

        function previewImage(input, previewId) {
            const preview = document.getElementById(previewId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" class="max-w-full h-32 object-cover rounded border">
                    `;
                };
                
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function analyzeDocument() {
            try {
                if (!currentVerificationSession) {
                    throw new Error('Debes iniciar una sesi√≥n de verificaci√≥n primero');
                }

                const documentType = document.getElementById('doc-type').value;
                const frontImageFile = document.getElementById('front-image').files[0];
                
                if (!frontImageFile) {
                    throw new Error('Debes subir al menos la imagen frontal del documento');
                }

                log(`üìÑ Analizando documento: ${documentType}`);

                // Convertir imagen a base64
                const frontImageBase64 = await fileToBase64(frontImageFile);
                
                // Simular an√°lisis (en la pr√°ctica usar√≠amos el endpoint real)
                setTimeout(() => {
                    const mockAnalysis = {
                        overallScore: Math.floor(Math.random() * 30) + 70, // 70-100
                        extractedData: {
                            fullName: "Juan P√©rez Gonz√°lez",
                            documentNumber: "12.345.678-9",
                            dateOfBirth: "1985-03-15"
                        },
                        fraudIndicators: {
                            suspiciousPatterns: Math.random() > 0.8 ? ["Calidad de imagen baja"] : []
                        }
                    };

                    document.getElementById('document-analysis-result').innerHTML = `
                        <div class="p-4 ${mockAnalysis.overallScore >= 80 ? 'bg-green-100 border-green-400' : 'bg-yellow-100 border-yellow-400'} border rounded">
                            <h5 class="font-medium mb-2">Resultado del An√°lisis</h5>
                            <div class="text-sm space-y-1">
                                <div><strong>Score:</strong> ${mockAnalysis.overallScore}%</div>
                                <div><strong>Nombre:</strong> ${mockAnalysis.extractedData.fullName}</div>
                                <div><strong>Documento:</strong> ${mockAnalysis.extractedData.documentNumber}</div>
                                <div><strong>Fecha de Nacimiento:</strong> ${mockAnalysis.extractedData.dateOfBirth}</div>
                                ${mockAnalysis.fraudIndicators.suspiciousPatterns.length > 0 ? 
                                    `<div class="text-yellow-700"><strong>Advertencias:</strong> ${mockAnalysis.fraudIndicators.suspiciousPatterns.join(', ')}</div>` : 
                                    '<div class="text-green-700"><strong>‚úÖ Documento v√°lido</strong></div>'
                                }
                            </div>
                        </div>
                    `;

                    log(`‚úÖ Documento analizado: Score ${mockAnalysis.overallScore}%`);
                }, 2000);

            } catch (error) {
                document.getElementById('document-analysis-result').innerHTML = `
                    <div class="p-3 bg-red-100 border border-red-400 rounded">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
                log(`‚ùå Error analizando documento: ${error.message}`);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        // Funciones de detecci√≥n de vida
        async function performLivenessCheck(checkType) {
            try {
                log(`üëÅÔ∏è Realizando detecci√≥n de vida: ${checkType}`);
                
                // Simular detecci√≥n
                const confidence = Math.floor(Math.random() * 30) + 70; // 70-100%
                const passed = confidence >= 85;
                
                const challenges = {
                    'blink_detection': 'Parpadee 3 veces lentamente',
                    'head_movement': 'Mueva la cabeza izquierda ‚Üí derecha',
                    'smile_detection': 'Sonr√≠a durante 2 segundos',
                    'voice_challenge': 'Diga: "Confirmo mi identidad"'
                };

                document.getElementById('liveness-result').innerHTML = `
                    <div class="p-4 ${passed ? 'bg-green-100 border-green-400' : 'bg-red-100 border-red-400'} border rounded">
                        <h5 class="font-medium mb-2">Resultado: ${checkType}</h5>
                        <div class="text-sm space-y-1">
                            <div><strong>Desaf√≠o:</strong> ${challenges[checkType]}</div>
                            <div><strong>Confianza:</strong> ${confidence}%</div>
                            <div><strong>Estado:</strong> ${passed ? '‚úÖ Aprobado' : '‚ùå Fall√≥'}</div>
                        </div>
                    </div>
                `;

                log(`${passed ? '‚úÖ' : '‚ùå'} Detecci√≥n de vida: ${confidence}% confianza`);
            } catch (error) {
                log(`‚ùå Error en detecci√≥n de vida: ${error.message}`);
            }
        }

        // Funciones RON
        async function scheduleRONSession() {
            try {
                if (!authToken) {
                    throw new Error('Debes estar autenticado');
                }

                const documentId = document.getElementById('ron-document-id').value;
                const notaryId = document.getElementById('ron-notary-id').value;
                const scheduledAt = document.getElementById('ron-scheduled-at').value;
                const participantsText = document.getElementById('ron-participants').value;

                if (!documentId || !notaryId || !scheduledAt || !participantsText) {
                    throw new Error('Todos los campos son requeridos');
                }

                let participants;
                try {
                    participants = JSON.parse(participantsText);
                } catch (e) {
                    throw new Error('Formato JSON inv√°lido para participantes');
                }

                log(`üé• Programando sesi√≥n RON para documento ${documentId}...`);

                const result = await apiCall('/api/ron/schedule', {
                    method: 'POST',
                    body: JSON.stringify({
                        documentId,
                        notaryId: parseInt(notaryId),
                        scheduledAt,
                        participants
                    })
                });

                document.getElementById('ron-schedule-result').innerHTML = `
                    <div class="p-4 bg-green-100 border border-green-400 rounded">
                        <strong>‚úÖ ${result.message}</strong><br>
                        <div class="text-sm mt-2">
                            <strong>ID de Sesi√≥n:</strong> ${result.sessionId}<br>
                            <strong>URL de Reuni√≥n:</strong> <a href="${result.meetingInfo.meetingUrl}" target="_blank" class="text-blue-600 underline">Abrir</a><br>
                            <strong>ID de Reuni√≥n:</strong> ${result.meetingInfo.meetingId}<br>
                            <strong>Contrase√±a:</strong> ${result.meetingInfo.meetingPassword}
                        </div>
                    </div>
                `;

                // Limpiar formulario
                document.getElementById('ron-document-id').value = '';
                document.getElementById('ron-scheduled-at').value = '';

                log(`‚úÖ Sesi√≥n RON programada: ${result.sessionId}`);
            } catch (error) {
                document.getElementById('ron-schedule-result').innerHTML = `
                    <div class="p-3 bg-red-100 border border-red-400 rounded">
                        <strong>‚ùå Error:</strong> ${error.message}
                    </div>
                `;
                log(`‚ùå Error programando RON: ${error.message}`);
            }
        }

        async function loadRONSessions() {
            try {
                if (!authToken) {
                    throw new Error('Debes estar autenticado');
                }

                log('üé• Cargando sesiones RON...');
                const sessions = await apiCall('/api/ron/sessions');

                let sessionsHtml = '';
                sessions.forEach(session => {
                    const statusColors = {
                        'scheduled': 'bg-blue-100 text-blue-800',
                        'in_progress': 'bg-yellow-100 text-yellow-800',
                        'completed': 'bg-green-100 text-green-800',
                        'cancelled': 'bg-red-100 text-red-800'
                    };

                    sessionsHtml += `
                        <div class="p-3 border rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="font-medium">Sesi√≥n ${session.id.slice(-8)}</div>
                                    <div class="text-sm text-gray-600">Documento: ${session.documentId}</div>
                                    <div class="text-xs text-gray-500">${new Date(session.scheduledAt).toLocaleString()}</div>
                                </div>
                                <span class="px-2 py-1 text-xs rounded ${statusColors[session.status] || 'bg-gray-100 text-gray-800'}">${session.status}</span>
                            </div>
                            <div class="mt-2 text-xs text-gray-500">
                                Participantes: ${session.participants.length} | Notario ID: ${session.notaryId}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('ron-sessions-list').innerHTML = sessionsHtml || '<p class="text-gray-500 text-sm">No hay sesiones RON</p>';
                log(`‚úÖ ${sessions.length} sesiones RON cargadas`);
            } catch (error) {
                log(`‚ùå Error cargando sesiones RON: ${error.message}`);
            }
        }

        // Inicializaci√≥n
        window.addEventListener('load', () => {
            log('üåê DocuSignPro RON cargado');
            
            // Configurar fecha m√≠nima para RON (ma√±ana)
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);
            document.getElementById('ron-scheduled-at').min = tomorrow.toISOString().slice(0, 16);
            
            // Mostrar primera pesta√±a
            showTab('identity');
            
            // Verificar autenticaci√≥n existente
            if (authToken) {
                log('üîë Token existente encontrado');
                document.getElementById('status-dot').className = 'w-3 h-3 bg-green-500 rounded-full';
                document.getElementById('status-text').textContent = 'Conectado';
            }
        });
    </script>
</body>
</html>